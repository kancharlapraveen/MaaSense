#include <Wire.h>
#include <Adafruit_TCS34725.h>

// --- PIN DEFINITIONS ---
const int FLUX_PIN      = 34;   
const int BUZZER_PIN    = 25;   
const int WHITE_LED_PIN = 18;  
const int YELLOW_LED_PIN = 19; 
const int RED_LED_PIN    = 5;  

// --- THRESHOLDS (Simplified for testing) ---
const float CONTRACTION_VOLT_LIMIT = 1.4; 
const int RED_COLOR_LIMIT = 800; // Adjust based on your lighting

Adafruit_TCS34725 tcs = Adafruit_TCS34725(TCS34725_INTEGRATIONTIME_50MS, TCS34725_GAIN_4X);

void setup() {
  Serial.begin(115200);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(WHITE_LED_PIN, OUTPUT); 
  pinMode(YELLOW_LED_PIN, OUTPUT); 
  pinMode(RED_LED_PIN, OUTPUT);

  if (tcs.begin()) {
    Serial.println("System Ready: Color Sensor Active");
  } else {
    Serial.println("Error: Color Sensor Not Found");
  }
}

void loop() {
  // 1. READ SENSORS
  float voltage = (analogRead(FLUX_PIN) * 3.3) / 4095.0;
  uint16_t r, g, b, c;
  tcs.getRawData(&r, &g, &b, &c);

  // 2. DEFINE STATES
  bool isContracting = (voltage > CONTRACTION_VOLT_LIMIT);
  bool isRedFluid = (r > RED_COLOR_LIMIT && r > g);
  bool isYellowFluid = (g > 500 && r > 500 && b < 400);

  // 3. IMMEDIATE LED LOGIC (PRIORITY BASED)
  
  // EMERGENCY: Red Fluid + Contraction (Red LED)
  if (isRedFluid && isContracting) {
    digitalWrite(RED_LED_PIN, HIGH);
    digitalWrite(YELLOW_LED_PIN, LOW);
    digitalWrite(WHITE_LED_PIN, LOW);
    
    // Rapid Alarm
    digitalWrite(BUZZER_PIN, HIGH); delay(50); digitalWrite(BUZZER_PIN, LOW); 
    Serial.println("!!! EMERGENCY: BLEEDING & CONTRACTION !!!");
  }
  
  // WARNING: Contraction OR any Fluid leak (Yellow LED)
  else if (isContracting || isRedFluid || isYellowFluid) {
    digitalWrite(RED_LED_PIN, LOW);
    digitalWrite(YELLOW_LED_PIN, HIGH);
    digitalWrite(WHITE_LED_PIN, LOW);
    
    // Slow Beep
    digitalWrite(BUZZER_PIN, HIGH); delay(300); digitalWrite(BUZZER_PIN, LOW);
    Serial.println("WARNING: Activity Detected");
  }
  
  // SAFE: Nothing detected (White LED)
  else {
    digitalWrite(RED_LED_PIN, LOW);
    digitalWrite(YELLOW_LED_PIN, LOW);
    digitalWrite(WHITE_LED_PIN, HIGH);
    digitalWrite(BUZZER_PIN, LOW);
  }

  // Debug data to Serial Monitor
  Serial.print("V: "); Serial.print(voltage);
  Serial.print(" | R: "); Serial.println(r);

  delay(200); // Fast updates for testing
}
